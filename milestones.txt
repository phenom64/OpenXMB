project:
  name: OpenXMB
  description: >
    PS3-style XrossMediaBar shell built with C++23 modules on top of a
    Vulkan + SDL2 renderer (AuroreEngine/dreamrender). Uses a JSON-based
    configuration, dynamic menus, icon + font systems, and an integrated
    FFmpeg video player. Emulation, optical media, and browser are planned.
  repos:
    - name: OpenXMB
      role: shell/app/menus/config/runtime
    - name: AuroreEngine (exposed as "dreamrender")
      role: renderer + GUI + IO (Vulkan backend, SDL2 integration)

tech_stack:
  graphics: [Vulkan (MoltenVK on macOS), SDL2]
  audio: [SDL2_mixer]
  media: [FFmpeg]
  text: [FreeType]
  optional_future: [libass (subtitles), HarfBuzz, MSDF, CEF, libretro, libbluray/libdvd*]
  build: [CMake, Ninja]
  os_targets: [Linux, macOS, Windows]

current_state:
  builds: [Linux, macOS (MoltenVK)]
  renderer: dreamrender integrated via FetchContent
  config: JSON (config.json). No YAML configs are in use.
  menus: settings_menu, applications_menu (Linux .desktop), users_menu (POSIX), files_menu
  programs: text_viewer, image_viewer, video_player (FFmpeg + YUV compute path)
  assets: loaded via XMB_ASSET_DIR; local package WIP
  i18n: i18n++ integrated; locales not fully packaged yet

proposed_build_flags:
  - name: ENABLE_BROWSER
    type: BOOL
    default: OFF
    desc: Build CEF-based browser module (off for SBC/light builds)
  - name: ENABLE_VIDEO_PLAYER
    type: BOOL
    default: ON
    desc: Build FFmpeg-based video player (currently implemented)
  - name: ENABLE_DISC_MEDIA
    type: BOOL
    default: OFF
    desc: Build DVD/Blu-ray glue (requires user-provided keys at runtime)
  - name: ENABLE_LIBRETRO
    type: BOOL
    default: OFF
    desc: Build libretro host module (planned)
  - name: HWACCEL
    type: STRING
    default: auto
    enum: [auto, off, vaapi, d3d11, videotoolbox]
    desc: Preferred hardware video decode backend (planned)

runtime_config:
  files:
    - path: ./config.json
      desc: Main runtime settings (render, controller, shell colors, paths, language, excludes)
  notes:
    - JSON is authoritative; no YAML configs exist in the repo at present.
    - XMB menu layout is code-driven; can be made data-driven later.

file_layout:
  OpenXMB:
    - src/app/                # shell (phase), components, layers
    - src/menu/               # menus (settings, files, apps, users)
    - src/programs/           # viewers (text/image/video)
    - src/render/             # render partitions (shaders, wave renderer)
    - src/config.*            # JSON-backed config module
    - src/constants.cppm      # paths, defaults, names
    - shaders/                # SPIR-V inputs embedded at build
    - scripts/XMS.sh.in       # launcher (sets VK_ICD on macOS, copies config)
    - config.json             # default runtime config (installed to share/OpenXMB)
  AuroreEngine (dreamrender):
    - Vulkan device/swapchain, renderers (GUI/image/font), helpers

app_loop:
  pseudocode: |
    SDL_Init(VIDEO|GAMECONTROLLER|AUDIO)
    dreamrender::window win{config_from_json}
    win.init()
    auto* shell = new app::shell(&win)
    if (--background-only) shell->set_background_only(true)
    win.set_phase(shell, shell, shell)
    win.loop()   # shell handles input, GUI, overlays, and rendering

modules:
  - id: menu_system
    repo: OpenXMB
    status: present
    summary: PS3-like crossbar + submenus (settings, files, apps, users)
    tasks_next:
      - Package icon set locally; remove hard XMB_ASSET_DIR requirement
      - Add metadata panels (title/subtitle/details)
      - Optional data-driven layout (JSON) and hot-reload

  - id: icon_system
    repo: OpenXMB
    status: basic
    summary: Icons loaded on demand; JSON-driven resolver for system icons
    tasks_next:
      - Build-time atlas and runtime LRU cache
      - Theme variants (light/dark/platform)

  - id: font_text_system
    repo: AuroreEngine/OpenXMB
    status: present (FreeType in engine)
    tasks_next:
      - macOS default font fallback (added in code) and UI selection
      - Optional: HarfBuzz shaping + MSDF glyph atlases

  - id: audio_mixer_music
    repo: AuroreEngine
    status: planned
    tasks:
      - Music bus + visualizer + SFX/system ducking

  - id: video_player
    repo: OpenXMB
    status: present (software decode; YUV GPU path)
    tasks_next:
      - HW accel selection (HWACCEL) and libass subtitles

  - id: browser_cef
    repo: OpenXMB
    status: planned (OFF by default)
    tasks:
      - CEF OSR integration, controller mapping, background policy

  - id: disc_media
    repo: OpenXMB
    status: planned (OFF by default)
    tasks:
      - libdvdread/libdvdnav/libbluray glue; device monitor; demux URL for player

  - id: libretro_host
    repo: OpenXMB
    status: planned (OFF by default)
    tasks:
      - Core host, framebuffer upload, audio routing, save/load, presets

apis (planned contracts):
  - Services: events/config/audio/renderer/icons/fonts
  - Overlay: show/hide/visible/pushPanel(id)
  - RendererSurfaces: register/unregister Surface{id, tex, rect, z}
  - Player: open/play/pause/stop/seek/videoTexture
  - Browser: openURL/back/forward/reload/texture/pump/injectInput
  - DiscService: start/stop/currentStatus/openMainTitle

data_models:
  config_json_example: |
    {
      "shell": {
        "background-color": "#1e1e1e",
        "wave-color": "#ffffff",
        "background-type": "wave",
        "background-image": "",
        "font-path": "default",
        "date-time-format": "%a %d %b %H:%M",
        "date-time-x-offset": 0.0,
        "language": "auto",
        "pictures-path": "~/Pictures",
        "music-path": "~/Music",
        "videos-path": "~/Videos",
        "excluded-applications": []
      },
      "controller": { "rumble": true, "analog-stick": true, "type": "auto" },
      "render": { "sample-count": 4, "max-fps": 100, "vsync": true, "show-fps": false, "show-mem": false }
    }

performance_plan (incremental):
  - persist VkPipelineCache; reuse transient images/buffers; upload ring
  - consider descriptor indexing and batching where feasible
  - keep frame graph responsibilities in engine (dreamrender), surface hooks in app

policies:
  background_apps: { min_ram_gb_for_browser: 4, background_browser_fps_cap: 30 }
  audio_ducking:   { overlay_duck_db: -8 }
  texture_budgets: { icon_atlas_mb: 32, cover_cache_mb_desktop: 256, cover_cache_mb_sbc: 128 }

milestones:
  - id: M1_scaffold
    goal: App compiles & runs; static XMB; JSON config
    status: done
    notes: macOS requires MoltenVK ICD; launcher now auto-detects common paths
  - id: M2_menu_fonts_icons
    goal: Navigable XMB with text & icons
    status: wip
    issues:
      - Package icons in share/shell; fallback to XMB_ASSET_DIR removed
      - Font picker + fallback in UI (macOS default applied if unset)
      - Metadata panel wiring
  - id: M3_audio_music_visualizer
    goal: Music playback + visualizer + ducking
    status: planned
  - id: M4_video_player
    goal: File playback (software), then HW accel + subtitles
    status: present (software); planned (HW/subtitles)
  - id: M5_libretro_overlay
    goal: Emulation with overlay
    status: planned
  - id: M6_browser
    goal: CEF OSR integration
    status: planned
  - id: M7_disc_media
    goal: Disc detect + DVD/BD glue
    status: planned
  - id: M8_perf_pass
    goal: Pipeline cache, upload ring, descriptor indexing review
    status: planned

acceptance:
  baseline:
    - 60 FPS navigating XMB at 1080p on mid-range iGPU
    - Music + visualizer smooth; no dropouts (later)
    - Video 1080p smooth; add HW accel + subtitles (later)
    - Emulated cores full-speed with overlay <80 ms open (later)
    - Browser background mode with FPS cap when RAM â‰¥ 4GB (later)
    - Disc entry appears when media present; plays if keys provided (later)

